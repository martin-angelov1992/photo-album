<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" type="text/css" href="/front-end/css/common.css">
		<script type="text/javascript" src="/front-end/js/jquery-3.2.1.min.js"></script>
		<script type="text/javascript">
			var pages = ["login", "register", 
				         "photos", "photo", 
				         "categories", "change-password",
				         "edit-profile", "edit-photo",
				         "edit-category"];
			
			$(document).on("click", "#logout", function() {
				
			});
			
			var requestInfo = null;
			
			$(window).on('hashchange', function() {
				var hash = window.location.hash;
				
				console.log("hash changed to "+hash);
				
				requestInfo = getRequestInfo(hash);
				populateContent(requestInfo.page);
			});
			
			$(document).ready(function() {
				var hash = window.location.hash;
				requestInfo = getRequestInfo(hash);
				
				populateProfileNav();
				populateContent(requestInfo.page);
			});
			
			function openPage(page) {
				console.log("opening page "+page);
				populateContent(page);
				runContentScript(page)
			}
			
			function populateContent(page) {
				console.log("populating content for page "+page);
				$("#content").load(page+".html");
				replaceContentClass(page);
				runContentScript(page);
			}

			function replaceContentClass(page) {
				var classList = document.getElementById('content').className.split(/\s+/);
				for (var i = 0; i < classList.length; i++) {
				    if (classList[i].startsWith("page-content-")) {
				        $('#content').removeClass(classList[i]);
				    }
				}
				
				$('#content').addClass("page-content-"+page);
			}

			function runContentScript(page) {
				console.log("loading js for page "+page);
				$.getScript("js/"+page+".js", function() {
					  var functionName = pageToJSFunctionName(page);
					  
					  // If function exists
					  if(typeof window[functionName] === 'function') {
					  	  window[functionName]();
					  }
				});
			}
			
			function pageToJSFunctionName(page) {
				var find = /(\-\w)/g;
				var convert =  function(matches){
				    return matches[1].toUpperCase();
				};
				
				var convertedPage = page.replace(
				    find,
				    convert
				);
				
				return "populate"+convertedPage;
			}
			
			function ucfirst(string) {
			    return string.charAt(0).toUpperCase() + string.slice(1);
			}
			
			function populateProfileNav() {
				$.getJSON( "/session", function(sessionInfo) {
					console.log("session: %o", sessionInfo);
					if (sessionInfo.loggedIn) {
						populateLoggedInProfileNav(sessionInfo.account);
					} else {
						populateNotLoggedInProfileNav();
					}
				});
			}
			
			function populateLoggedInProfileNav(account) {
				var content = "<a href='#edit-profile'>Profile</a> | <a href='#change-password'>Change Password</a>"+
				" | <a href='#create-category'>Create Category</a> | <a href='#upload-photo'>Upload Photo</a>";
				$("#profile-nav").html(content);
			}
			
			function populateNotLoggedInProfileNav() {				
				var content = "<a href='#login'>Login</a> | <a href='#register'>Register</a>";
				$("#profile-nav").html(content);
			}
			
			function getRequestInfo(hash) {
				hash = hash.substring(1);
				
				var parts = hash.split("?");
				
				var info = {};
				var page = parts[0];
				var theRest = "";
				
				if (parts.length > 1) {
					theRest = parts[1];
				}
				
				if (page == null || page == "") {
					info['page'] = "categories";
				} else {
					info['page'] = page;
				}
				
				var params = getParams(theRest);
				
				for (key in params) {
					info[key] = params[key];
				}
				
				return info;
			}
			
			function getParams(str) {
				var params = {};
				var parts = str.split("&");
				
				for (i in parts) {
					var paramParts = parts[i].split("=");
					
					var name = paramParts[0];
					var value = paramParts[1];
					
					params[name] = value;
				}
				
				return params;
			}
		
			function escapeHtml(text) {
			    'use strict';
			    return text.replace(/[\"&<>]/g, function (a) {
			        return { '"': '&quot;', '&': '&amp;', '<': '&lt;', '>': '&gt;' }[a];
			    });
			}
			
			function capitalizeFirstLetter(string) {
			    return string.charAt(0).toUpperCase() + string.slice(1);
			}
		
			function convertConstantToKey(constant) {
				var key = "";
				var parts = constant.split("_");
			  
			  for (i in parts) {
			  	var part = parts[i];
			    var lowerCasePart = part.toLowerCase();
			    
			  	if (i == 0) {
			      key += lowerCasePart;
			    	continue;
			    }
			    
			    key += capitalizeFirstLetter(lowerCasePart);
			  }
			  
			  return key;
			}
		
			function showError(errorCode) {
				var errorKey = convertConstantToKey(constant);
				
				var errorText = errorMap[errorCode];
		
				$("#errorHolder").text(errorText);
			}
		</script>
	</head>
	<body>
		<div id="header"><span id="profile-nav"></span></div>
			<div id="content"></div>
		<div id="footer"></div>
	</body>
</html>